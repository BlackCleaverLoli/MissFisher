# 钓法表达式（Angle Expression）
> 本文默认读者已经掌握《最终幻想14》中的基本操作和钓鱼玩法的各种基本要点。

# 本文还未完工

## 什么是钓法表达式？

钓法表达式是一种专门设计给自动钓鱼插件 MissFisher（下称 MF）的文本指令。它由一系列预定义的关键字、操作符与定界符，以及游戏内物品名称或 ID 等字面量组成，用于声明式描述特定场景下的钓鱼策略，从而快速配置并启动 MF 的自动钓鱼功能。

## 术语


|  游戏机制   | 描述                                                                       |
|:-------:|--------------------------------------------------------------------------|
|  耐心系技能  | 指耐心和耐心II                                                                 |
| 以小钓大系技能 | 指以小钓大和以小钓大II                                                             |
| 以小钓大机会  | 可使用不同的以小钓大系技能                                                            |
|  以小钓大链  | 由可以小钓大的鱼和使用以小钓大钓到的鱼组成的链                                                  |
| 以小钓大循环  | 以小钓大链中的局部循环<br/>某些鱼类在被用来以小钓大时，相同的鱼类会咬饵                                   |
|   稀有度   | 鱼类物品图标的背景色，稀有度从低到高：白/灰（无背景色）→绿→蓝                                         |
|   尺寸    | 鱼类的属性，与稀有度无关                                                             |
|  大尺寸鱼类  | 钓到时会获得与钓到的鱼类数量相同的捕鱼人之计层数<br/>若钓到的鱼类可被用来以小钓大，且尺寸到达一定数值，则可使用以小钓大来消耗其进行以小钓大 |

SE 定义的技能类别：

| 技能类别 | 包含                                                                  |
|:----:|---------------------------------------------------------------------|
|  基础  | 选饵、抛竿、提钩、中断、歇竿、垂钓之光                                                 |
|  准备  | 耐心、耐心II、大鱼猎手、大鱼的知识、以小钓大、以小钓大II、熟练渔技、熟练妙招、撒饵、钓组、鱼眼、拍击水面、专一垂钓、放生、放生列表 |
|  提钩  | 强力提钩、精准提钩、双重提钩、三重提钩                                                 |
|  诱饵  | 雄心之饵、谦逊之饵                                                           |
|  其他  | 隐行、沙利亚克的恩宠、收藏品采集                                                    |


|  程序定义  | 描述                                                                                                                                                                           |
|:------:|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|  准备状态  | 抛竿或以小钓大前的状态，角色此时可使用准备技能                                                                                                                                                      |
| 等待咬饵状态 | 抛竿或以小钓大后的状态，角色此时可使用提钩技能、诱饵技能以及部分基础技能与部分其他技能                                                                                                                                  |
|  抛竿阶段  | 上一个等待咬饵状态的开始到下一个等待咬饵阶段的开始的时间段，被视为一个完整的抛竿阶段。<br/>抛竿阶段共有 4 个：从 0 到 3<br/>每次以小钓大系技能被使用都会将抛竿阶段推进 1；<br/>每次不带游动饵的抛竿被使用都会将抛竿阶段重置到 0；<br/>每次带游动饵的抛竿将使抛竿阶段被设为该游动饵被存为游动饵前的鱼类的抛竿阶段加 1。 |

---

## 词法单元

### 操作符、定界符与分隔符


|         中文输入法          |         英文输入法          |     类型     | 描述                       |
|:----------------------:|:----------------------:|:----------:|--------------------------|
|          `》`           |          `>`           | 钓法参数引入操作符  | 表示抛竿后参数的开始               |
|          `+`           |          `+`           | 特殊参数连接分隔符  |  连接不同状态下咬饵时间的区间端点或咬饵类型标记 |
|        `-` `~`         |        `-` `~`         |  数字连接分隔符   | 连接数字                     |
|         `【 】`          |         `[ ]`          |  物品集合定界符   | 包裹物品参数                   |
|          `\|`          |          `\|`          |  别名连接分隔符   | 连接物品的名称和 ID              |
|          `、`           |         `\|\|`         |  集合元素分隔符   | 分隔集合中的元素                 |
|          `=`           |          `=`           | 全局参数起始操作符  |                          |
|          `；`           |          `;`           |  全局参数分隔符   |                          |
|          `@`           |          `@`           |   触发器操作符   | 满足特定条件时执行触发器操作符后的操作      |
|         `（ ）`          |         `( )`          |  特殊集合定界符   | 包裹特定参数                   |
|          `？`           |          `?`           |  排除集合操作符   |                          |
|          `《`           |          `<`           |   游动饵操作符   |                          |
|          `=》`          |          `=>`          | 嵌套表达式引入操作符 |                          |
|          `《=`          |          `<=`          | 嵌套表达式闭合操作符 |                          |

### 关键字

#### 模式关键字

| 中文输入法 | 英文输入法 | 描述                |
|:-----:|:-----:|-------------------|
| `平钓`  | `nm`  | 不使用增加钓到大尺寸鱼类概率的技能 |
| `大鱼`  | `bf`  | 使用大鱼猎手来获取大尺寸鱼类    |
| `耐心`  | `pt`  |  使用耐心系技能来获取大尺寸鱼类  |

#### 咬饵类型关键字

| 中文输入法 | 英文输入法 | 描述                                 |
|:-----:|:-----:|------------------------------------|
| `全部`  | `all` | 等价于同时列举并使用特殊连接操作符连接的 3 种不重复的咬饵类型标记 |

#### 触发类型关键字

| 中文输入法 | 英文输入法 | 描述 |
|:-----:|:-----:|----|
| `拍水`  | `ss`  |    |
| `专一`  | `ic`  |    |
| `阶段`  | `stg` |    |
| `鱼识`  | `int` |    |
| `拍水后` | `pss` |    |

#### 物品集合关键字

| 中文输入法 | 英文输入法 | 描述 |
|:-----:|:-----:|----|
| `任何`  | `any` |    |
| `占位`  | `ph`  |    |

#### 提钩类型关键字

| 中文输入法 | 英文输入法 | 描述     |
|-------|-------|--------|
| `强力`  | `pw`  | 使用强力提钩 |
| `精准`  | `pc`  | 使用精准提钩 |
| `双提`  | `dh`  | 使用双重提钩 |
| `双重`  | `dh`  | 使用双重提钩 |
| `三提`  | `th`  | 使用三重提钩 |
| `三重`  | `th`  | 使用三重提钩 |
| `华丽`  | `sh`  | 使用华丽提钩 |


#### 钓法修饰词

| 中文输入法  |   英文输入法   | 描述 |
|:------:|:---------:|:---|
| `不撒饵`  | `nochum`  |    |
| `收藏品`  |  `coll`   |    |
| `不收集`  | `nocoll`  |    |
|  `钓组`  |  `snag`   |    |
| `大尺寸`  |  `large`  |    |
| `攒鱼计`  |   `aa`    |    |
|  `套娃`  |  `loop`   |    |
| `等待专一` | `waitic`  |    |
| `大鱼知识` |   `bfg`   |    |
|  `引诱`  |  `lure`   |    |
|  `雄心`  | `a-lure`  |    |
|  `谦逊`  | `m-lure`  |    |
|  `重随`  | `re-roll` |    |
|  `鱼影`  | `shadow`  |    |
|  `多提`  |   `mh`    |    |
|  `回收`  |  `recy`   |    |
|  `鱼眼`  |   `fe`    |    |
|  `鱼篓`  |   `sh`    |    |
| `鱼篓专一` |  `sh-ic`  |    |
| `跳阶段`  | `skipstg` |    |
|  `银星`  | `silver`  |    |
| `无强心剂` | `nocord`  |    |

---

## 开始学习
###  验证钓法表达式
使用正则表达式对钓法表达式进行词法与结构合法性检查：[Regex101: Angex Latest](https://regex101.com/r/gA6Cow)

### 测试环境
当需要测试钓法表达式时，建议的钓场：
- 永夏岛北
  - 拉诺西亚 - 东拉诺西亚（36.0, 26.6）[在鱼糕上的永夏岛北](https://fish.ffmomola.com/#/wiki/fishing/spot/156)
  - 在永夏岛北使用沙蚕钓鱼时，能获得极其稳定的以小钓大链：
    在抛竿后，咬饵的总是梅尔托尔虾虎，使用梅尔托尔虾虎以小钓大时，咬饵的总是罗敏萨鳀鱼。且该钓场有所有咬饵类型，且包括必须在特定条件才能钓到的鱼类。

## 0. 基本语法与结构
钓法表达式应从左到右在同一行书写，且除了鱼名外应不包含任何空格。

基本结构如下，按顺序排列。

- 其中 `<>` 表示必须结构，`[]` 表示可选结构，`|` 分割在同一参数位的不同参数。
  - 这些符号在此仅作结构说明，而不属于钓法表达式的一部分：
```text
<模式、钓饵与窗口期> <抛竿后钓法> [终止目标、计数器与修饰词] [嵌套的钓法表达式] [注释]
```

- 模式、钓饵与窗口期参数的结构：
```text
<模式关键字> [钓饵] [ET窗口期] [天气窗口期]
```

- 抛竿后钓法参数的结构：
```text
<抛竿后第1次以小钓大前的钓法> [第1次以小钓大后的钓法] [第2次以小钓大后的钓法] [第3次以小钓大后的钓法]
```

- 终止目标、计数器与修饰词参数的结构：
```text
[终止目标] [计数器1] [计数器2] [计数器3] [钓法修饰词]
```

- 嵌套的钓法表达式参数的结构：

```text
[计数器满足时切换的钓法表达式] [获得鱼识或拍击水面时切换的钓法表达式]
```

### 0.1 使用不同的输入法书写
钓法表达式可使用中文输入法或英文输入法来书写；表示相同词法单元的不同字符变体在语义上等效。

## 1. 必须结构

一条完整的钓法表达式必须至少由以下部分组成：  
必须以 [模式关键字](#11-模式关键字) 开始、然后是 [钓法参数引入操作符](#12-钓法参数引入操作符)、然后是 [咬饵类型符 或 咬饵类型关键字](#13-咬饵类型标记和咬饵类型关键字)。

- 一个最简的例子：这样写，MF 将在准备状态使用抛竿，并在角色模型上方出现任意类型的咬饵提示时使用提钩。
```angex
平钓》全部
nm>any
```

### 1.1 模式关键字
钓法表达式必须以模式关键字开始。

MF 将因为不同的模式关键字而在钓鱼的准备状态使用不同的技能，采取的钓鱼策略也将不同。


| 中文输入法 | 英文输入法 | 描述                |
|:-----:|:-----:|-------------------|
| `平钓`  | `nm`  | 不使用增加钓到大尺寸鱼类概率的技能 |
| `大鱼`  | `bf`  | 使用大鱼猎手来获取大尺寸鱼类    |
| `耐心`  | `pt`  |  使用耐心系技能来获取大尺寸鱼类  |

### 1.2 钓法参数引入操作符
使用 `》` 或 `>` 作为不同抛竿阶段的钓法参数的引入操作符。

- 这样写，将使 MF 在准备状态使用抛竿，并仅在角色模型上方出现类型为 `!` 的咬饵提示时使用提钩；当钓到的鱼类可被用来以小钓大时，MF 将使用以小钓大系技能，最后当角色模型上方出现类型为 `!!` 的咬饵提示时，MF 将使用提钩。
```angex
大鱼》！》！！
bf>!>!!
```

> 助记：你可以将其看作一个箭头，每个 `》` 表示一次抛竿或以小钓大，指向抛竿或以小钓大后的钓法参数。
### 1.3 咬饵类型标记和咬饵类型关键字
> 搜索关键词：竿型、杆
#### 1.3.1 咬饵类型标记
`！` 或 `!` 是组成咬饵类型标记的最小标记单位。咬饵类型标记与游戏中的咬饵事件发生时，角色模型上方出现的 `!` 标记直接对应。

| 中文输入法  | 英文输入法 | 描述          |
|:------:|:-----:|-------------|
|  `！`   |  `!`  | 对应 `!` 标记   |
|  `！！`  | `!!`  | 对应 `!!` 标记  |
| `！！！`  | `!!!` | 对应 `!!!` 标记 |

- 这样写，MF 将在准备状态使用抛竿，并仅在角色模型上方出现 `!!!` 类型的咬饵提示时使用提钩。
```angex
平钓》！！！
nm>!!!
```

#### 1.3.2 使用多个咬饵类型标记
使用 `+` 作为咬饵类型标记连接符，将多个咬饵类型标记组合成一个集合。

- 这样写，MF 将在准备状态使用抛竿，并仅在角色模型上方出现 `!` 或 `!!!` 类型的咬饵提示时使用提钩。
```angex
平钓》！+！！！
nm>!+!!!
```

- 咬饵类型标记不区分顺序，下面的钓法表达式的语义等效于上一条。
```angex
平钓》！！！+！
nm>!!!+!
```
> 建议：为了可读性，编写时建议「从小到大」，也就是说在连接 `！` 和 `！！！` 时建议写为 `！+！！！` 而非 `！！！+！`
#### 1.3.3 咬饵类型关键字
使用 `全部` 或 `any` 作为咬饵类型关键字，它们的语义等效于 `!+!!+!!!`，即响应任意咬饵类型。

在同一参数位中，不能同时使用咬饵类型标记与咬饵类型关键字。

- 这样写，MF 将在准备状态使用抛竿，并在角色模型上方出现任意类型的咬饵提示时使用提钩。
```angex
平钓》全部
nm>any
```

## 2. 全局参数
使用 `=` 作为全局参数的起始操作符。
### 2.1 终止目标
在 `=` 后使用 `【 】` 或 `[ ]` 包裹物品名称或物品 ID，然后使用 `；` 或 `;` 作为全局参数分隔符来闭合，作为终止目标参数。

- 如果提供的是物品名称，MF 将尝试使用所在客户端的内部物品表格来转换到 ID。
- 因此，物品名称应使用钓法表达式将使用的客户端的语言来表示。
  - 不限大小写；
  - 如有复数变体，应使用单数形式。

- 这样写，MF 将在钓上名称为 `梅尔托尔虾虎` 的鱼类时报告并终止自动钓鱼。
```angex
平钓》全部=【梅尔托尔虾虎】
nm>any=[Merlthor Goby]//only for EN client
```

> 规范：除非仅在对应物品名称的语言的客户端使用，否则在编写将公开的钓法表达式时，应使用下文中展示的写法。
#### 2.1.1 别名连接分隔符
可在相同参数位同时使用物品名称与物品 ID；先写名称，然后使用 `|` 连接 ID。  
此时名称将作为提升可读性的字面量；MF 将优先使用 ID，如果 ID 不合法，将尝试转换名称。

- 这样写，MF 将在钓上名称为 `梅尔托尔虾虎` 的鱼类时报告并终止自动钓鱼。
```angex
平钓》全部=【梅尔托尔虾虎|4869】
nm>any=[Merlthor Goby|4869]
```


